# Workflow Automation - Testing Guide

**Feature:** Alerts & Batch Operations
**Status:** Ready for Testing
**Date:** 2025-10-12

---

## Prerequisites

### 1. Database Migration
```bash
# Check if migration ran
psql $DATABASE_URL -c "SELECT * FROM information_schema.tables WHERE table_name IN ('alerts', 'batch_operations', 'payroll_events');"

# Should show 3 tables
# If not, run migration:
psql $DATABASE_URL -f supabase/migrations/20251012_create_workflow_automation_tables.sql
```

### 2. Start Development Server
```bash
npm run dev
# or
pnpm dev
```

### 3. Login as HR Manager or Admin
- HR Manager role: Can see alerts, create batch operations
- Admin role: Full access to all features

---

## Test Scenarios

### Scenario 1: Alerts Dashboard Widget

**Location:** `/admin/settings/dashboard` or `/payroll/dashboard`

**Test Steps:**
1. Navigate to admin or payroll dashboard
2. Look for "Alertes" widget at the top

**Expected Results:**
- âœ… Widget displays with bell icon
- âœ… Shows "Aucune alerte" if no alerts exist
- âœ… Shows top 5 urgent alerts if they exist
- âœ… Badge count displays number of urgent alerts
- âœ… "Voir tout" button navigates to `/alerts`

**Test Edge Cases:**
- Empty state (no alerts)
- Loading state (slow network)
- Error state (API failure)

---

### Scenario 2: Alerts Navigation

**Location:** Sidebar navigation (desktop)

**Test Steps:**
1. Look at sidebar navigation
2. Find "Alertes" menu item under "Tableau de bord" section

**Expected Results:**
- âœ… "Alertes" menu item visible with bell icon
- âœ… Click navigates to `/alerts`
- âœ… Active state when on alerts page

---

### Scenario 3: Alerts Page - Active Tab

**Location:** `/alerts`

**Test Steps:**
1. Navigate to `/alerts`
2. Default view should show "Actives" tab

**Expected Results:**
- âœ… Page title "Alertes" with bell icon
- âœ… Tabs: Actives / IgnorÃ©es / TerminÃ©es
- âœ… "Actives" tab selected by default
- âœ… Severity filter dropdown visible
- âœ… "Tout ignorer" button visible if alerts exist

**Test Filtering:**
1. Click severity dropdown
2. Select "Urgentes"
3. Expected: Only urgent alerts shown
4. Select "Toutes"
5. Expected: All active alerts shown

---

### Scenario 4: Alert Card Actions

**Test Steps:**
1. Find an alert card
2. Click primary action button (e.g., "Renouveler le contrat")
3. Expected: Navigate to action URL

4. Click "Plus tard" or dismiss (X) button
5. Expected:
   - Toast: "Alerte ignorÃ©e"
   - Alert disappears from list
   - Alert moves to "IgnorÃ©es" tab

6. Click "Marquer comme fait"
7. Expected:
   - Toast: "Alerte marquÃ©e comme terminÃ©e"
   - Alert disappears from list
   - Alert moves to "TerminÃ©es" tab

---

### Scenario 5: Bulk Dismiss

**Test Steps:**
1. Have multiple active alerts
2. Click "Tout ignorer" button
3. Confirm dialog
4. Expected:
   - Toast: "X alertes ignorÃ©es"
   - All alerts move to "IgnorÃ©es" tab
   - "Actives" tab shows empty state

---

### Scenario 6: Create Test Alerts (Manual)

Since alerts are generated by scheduled jobs (not yet implemented), you can manually create test alerts via SQL:

```sql
-- Get your user ID
SELECT id FROM users WHERE email = 'your-email@example.com';

-- Create test urgent alert
INSERT INTO alerts (tenant_id, type, severity, message, assignee_id, employee_id, action_url, action_label, status)
VALUES (
  (SELECT tenant_id FROM users WHERE email = 'your-email@example.com'),
  'contract_expiry',
  'urgent',
  'Contrat de Jean Dupont expire dans 5 jours',
  (SELECT id FROM users WHERE email = 'your-email@example.com'),
  (SELECT id FROM employees LIMIT 1), -- Pick any employee
  '/employees/xxx/assignments/xxx',
  'Renouveler le contrat',
  'active'
);

-- Create test warning alert
INSERT INTO alerts (tenant_id, type, severity, message, assignee_id, employee_id, action_url, action_label, status)
VALUES (
  (SELECT tenant_id FROM users WHERE email = 'your-email@example.com'),
  'contract_expiry',
  'warning',
  'Contrat de Marie Martin expire dans 12 jours',
  (SELECT id FROM users WHERE email = 'your-email@example.com'),
  (SELECT id FROM employees OFFSET 1 LIMIT 1),
  '/employees/xxx/assignments/xxx',
  'Renouveler le contrat',
  'active'
);

-- Create test info alert
INSERT INTO alerts (tenant_id, type, severity, message, assignee_id, employee_id, action_url, action_label, status)
VALUES (
  (SELECT tenant_id FROM users WHERE email = 'your-email@example.com'),
  'document_expiry',
  'info',
  'Permis de travail expire dans 25 jours',
  (SELECT id FROM users WHERE email = 'your-email@example.com'),
  (SELECT id FROM employees OFFSET 2 LIMIT 1),
  '/employees/xxx/documents',
  'Renouveler le document',
  'active'
);
```

---

### Scenario 7: Batch Operations (Future Test)

**Note:** Batch operations are implemented but not yet integrated into employee list UI.

**Manual Test via tRPC:**
```typescript
// In browser console on /employees page
const result = await window.trpc.batchOperations.updateSalaries.mutate({
  employeeIds: ['employee-id-1', 'employee-id-2'],
  updateType: 'percentage',
  value: 10,
  effectiveDate: new Date('2025-02-01'),
  reason: 'Augmentation annuelle 2025'
});

console.log(result); // Check operation created

// Check status
const status = await window.trpc.batchOperations.getStatus.query({
  id: result.operation.id
});

console.log(status); // Check progress
```

---

## Mobile Testing

### Devices to Test
- iPhone SE (375Ã—667) - smallest modern phone
- iPhone 12 (390Ã—844) - standard phone
- iPad (768Ã—1024) - tablet
- iPad Pro (1024Ã—1366) - large tablet

### Mobile Checklist
- [ ] Alerts widget responsive on all screen sizes
- [ ] Touch targets â‰¥44px (buttons, links)
- [ ] Tabs swipeable on mobile
- [ ] Alert cards readable on small screens
- [ ] Filters accessible on mobile
- [ ] Bottom navigation doesn't overlap content

---

## Performance Testing

### Metrics to Measure
1. **Alerts Widget Load Time**
   - Target: < 300ms
   - Measure: Chrome DevTools Network tab

2. **Alerts Page Load Time**
   - Target: < 500ms for 20 alerts
   - Measure: Chrome DevTools Performance tab

3. **Dismiss Alert Response**
   - Target: < 200ms
   - Measure: Network tab (tRPC mutation)

### Load Testing
```sql
-- Create 100 test alerts
INSERT INTO alerts (tenant_id, type, severity, message, assignee_id, status)
SELECT
  tenant_id,
  'test_alert',
  CASE (random() * 2)::int
    WHEN 0 THEN 'info'
    WHEN 1 THEN 'warning'
    ELSE 'urgent'
  END,
  'Test alert ' || generate_series,
  (SELECT id FROM users WHERE tenant_id = alerts.tenant_id LIMIT 1),
  'active'
FROM generate_series(1, 100)
CROSS JOIN (SELECT tenant_id FROM users LIMIT 1) AS u;
```

---

## Error Scenarios

### Test Error Handling

1. **Network Failure**
   - Open DevTools â†’ Network tab
   - Set throttling to "Offline"
   - Try to load alerts
   - Expected: Error message "Erreur lors du chargement"

2. **Invalid Alert ID**
   - Manually navigate to `/alerts?id=invalid-uuid`
   - Expected: Error toast or 404 message

3. **Unauthorized Access**
   - Logout
   - Try to access `/alerts`
   - Expected: Redirect to login

4. **Empty State**
   - Delete all alerts
   - Visit `/alerts`
   - Expected: Friendly empty state message

---

## Accessibility Testing

### Keyboard Navigation
- [ ] Tab key navigates through all interactive elements
- [ ] Enter key activates buttons
- [ ] Esc key closes dialogs/dropdowns
- [ ] Focus indicators visible

### Screen Reader (macOS VoiceOver)
```bash
# Enable VoiceOver
cmd + F5
```

- [ ] Alert severity announced
- [ ] Alert message read clearly
- [ ] Action buttons labeled correctly
- [ ] Tab names announced

### Color Contrast
- [ ] Urgent alerts (red) readable
- [ ] Warning alerts (yellow) readable
- [ ] Info alerts (blue) readable
- [ ] Text meets WCAG AA standards (4.5:1)

---

## Browser Testing

### Required Browsers
- [ ] Chrome (latest)
- [ ] Safari (latest)
- [ ] Firefox (latest)
- [ ] Edge (latest)

### Mobile Browsers
- [ ] Safari iOS
- [ ] Chrome Android

---

## Regression Testing

After alerts are working, verify other features still work:

- [ ] Dashboard loads normally
- [ ] Navigation sidebar works
- [ ] Employee list page loads
- [ ] Payroll pages load
- [ ] No console errors

---

## Known Issues / Limitations

1. **Alert Generation**: Scheduled job not yet implemented
   - Workaround: Manually insert alerts via SQL
   - TODO: Implement Inngest cron job

2. **Batch Operations UI**: Not yet integrated into employee list
   - Workaround: Test via tRPC console
   - TODO: Add BulkSalaryUpdateDialog to employee list

3. **Real-time Updates**: No WebSocket support yet
   - Workaround: Refresh page to see updates
   - TODO: Add WebSocket or polling

4. **Push Notifications**: Not implemented
   - TODO: Add mobile push notifications

---

## Success Criteria

**Phase 1 is complete when:**
- âœ… Alerts visible on dashboard
- âœ… Alerts page fully functional
- âœ… Navigation includes alerts link
- âœ… All CRUD operations work (list, dismiss, complete)
- âœ… Mobile responsive
- âœ… No critical bugs

**Ready for Production when:**
- âœ… All above criteria met
- âœ… Scheduled job implemented (daily alerts)
- âœ… Performance benchmarks met
- âœ… Accessibility requirements met
- âœ… Cross-browser tested
- âœ… User acceptance testing passed

---

## Reporting Bugs

When reporting bugs, include:
1. **Steps to reproduce**
2. **Expected behavior**
3. **Actual behavior**
4. **Screenshot/video** (if applicable)
5. **Browser/device info**
6. **Console errors** (if any)

**Example Bug Report:**
```
Title: Alert dismiss button not working on mobile

Steps:
1. Open /alerts on iPhone SE
2. Tap "Plus tard" button on urgent alert
3. Nothing happens

Expected: Alert dismissed, toast notification shown
Actual: No response, button appears stuck

Device: iPhone SE iOS 17.1, Safari
Console: TypeError: Cannot read property 'mutate' of undefined
Screenshot: [attached]
```

---

## Next Testing Phase

After Phase 1 testing complete:
1. Implement Inngest event bus
2. Add scheduled jobs (daily alerts)
3. Integrate batch operations into employee list
4. Test event-driven payroll automation
5. Add background job processing

---

**Happy Testing! ðŸš€**
